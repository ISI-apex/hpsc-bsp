From b55ec8b676ed05d93ee49d6c79ae0403616c4fb0 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Mon, 9 Oct 2017 13:21:44 +1030
Subject: [PATCH] PR22212, memory leak in nm

	PR 22212
	* dwarf2.c (_bfd_dwarf2_cleanup_debug_info): Free
	funcinfo_hash_table and varinfo_hash_table.

Upstream-Status: Backport
Affects: <= 2.29.1
CVE: CVE-2017-15225
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 bfd/ChangeLog | 6 ++++++
 bfd/dwarf2.c  | 4 ++++
 2 files changed, 10 insertions(+)

Index: git/bfd/dwarf2.c
===================================================================
--- git.orig/bfd/dwarf2.c
+++ git/bfd/dwarf2.c
@@ -4932,6 +4932,10 @@ _bfd_dwarf2_cleanup_debug_info (bfd *abf
 	}
     }
 
+  if (stash->funcinfo_hash_table)
+    bfd_hash_table_free (&stash->funcinfo_hash_table->base);
+  if (stash->varinfo_hash_table)
+    bfd_hash_table_free (&stash->varinfo_hash_table->base);
   if (stash->dwarf_abbrev_buffer)
     free (stash->dwarf_abbrev_buffer);
   if (stash->dwarf_line_buffer)
Index: git/bfd/ChangeLog
===================================================================
--- git.orig/bfd/ChangeLog
+++ git/bfd/ChangeLog
@@ -1,3 +1,9 @@
+2017-10-09  Alan Modra  <amodra@gmail.com>
+
+       PR 22212
+       * dwarf2.c (_bfd_dwarf2_cleanup_debug_info): Free
+       funcinfo_hash_table and varinfo_hash_table.
+
 2017-09-24  Alan Modra  <amodra@gmail.com>
 
        PR 22186
